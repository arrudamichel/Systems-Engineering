<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="">
	<meta name="author" content="">
	<link rel="shortcut icon" href="img/favicon.ico" >
	
	<title>Estatísticas - TransReport</title>

	<!-- Bootstrap Core CSS -->
	<link href="css/bootstrap.min.css" rel="stylesheet">

	<!-- Custom CSS -->
	<link href="css/landing-page.css" rel="stylesheet">
	<link href="css/nv.d3.css" rel="stylesheet">
	
	<!-- Ana CSS -->
	<link href="css/style.css" rel="stylesheet">

	<!-- Custom Fonts -->
	<link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
	<link href="http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css">

	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	<!--[if lt IE 9]>
		<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
		<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
		<![endif]-->

		<style type="text/css">
			.axis text {
				font: 15px sans-serif;
			}

			.axis path,
			.axis line {
				fill: none;
				stroke: #000;
				shape-rendering: crispEdges;
			}

			.bar {
				fill: steelblue;
				fill-opacity: .9;
			}

			.x.axis path {
				display: none;
			}
			.label-text {
			    alignment-baseline: middle;
			    font-size: 12px;
			    font-family: arial,helvetica,"sans-serif";
			    fill: #393939;
			}
			.label-line {
			    stroke-width: 1;
			    stroke: #393939;
			}
			.label-circle {
			    fill: #393939;
			}
			#stats2{
				text-align: center;
			}
			.titulo{
				color: #747474;
				text-align: center;
			}
			#stats2 svg {
			    margin-bottom: 5em;
			    margin-top: -15em;
			}
			
			<!--stats3-->
			  #test .arc2 {
            stroke-weight:0.1;
            fill: #3660b0;
        }

        #outer {
            background:#FFFFFF;
            border-radius: 5px;
            color: #000;
        }

        #div1, #div2, #div3, #div4 {
            width: 33%;
            height: 200px;
            box-sizing: border-box;
            float: left;
        }

        #div2 .arc {
            stroke-weight: 0.1;
            fill: #f0a417;
        }

        #div2 .arc2 {
            stroke-weight: 0.1;
            fill: #b00d08;
        }

        #div3 .arc {
            stroke-weight: 0.1;
            fill: #1d871b;
        }


        .selectedRadial {
            border-radius: 3px;
            background: #f4f4f4;
            color: #000;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            -moz-box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            border: 1px solid rgba(200,200,200,0.85);
        }

        .radial {
            border-radius: 3px;
            background: #FFFFFF;
            color: #000;

        }
		</style>

	</head>

	<body>
		<!-- Navigation -->
		<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
			<div class="container">
				<!-- Brand and toggle get grouped for better mobile display -->
				<div class="navbar-header">
					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#menu">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="navbar-brand" href="#">TransReport</a>
				</div>
				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="collapse navbar-collapse" id="menu">
					<ul class="nav navbar-nav navbar-right">
						<li>
							<a href="#sobre"><i class="fa fa-info-circle"></i> Sobre</a>
						</li>
						<li>
							<a href="#estatistica"><i class="fa fa-bar-chart"></i> Estatísticas</a>
						</li>
						<li>
							<a href="#equipe"><i class="fa fa-users"></i> Equipe</a>
						</li>
						<li>
							<a href="#reclamacao"><i class="fa fa-comment"></i> Reclamação</a>
						</li>
						<li>
							<a href="#faleconosco"><i class="fa fa-envelope"></i> Fale Conosco</a>
						</li>
					</ul>
				</div>
				<!-- /.navbar-collapse -->
			</div>
			<!-- /.container -->
		</nav>

		<!-- Estatísticas -->
	<div class="middle">
		<div class="container">
			<div class="row">
				<div class="col-lg-12 col-sm-10">
					<hr class="section-heading-spacer">
					<div class="clearfix"></div>
					<h2 class="section-heading" style="margin-top:50px;"><i class="fa fa-bar-chart"></i> Estatísticas</h2>
				</div>
			</div>
			<div class="banner">
			<div class="row">
				
				<h4 class="section-heading">Top 10 - Problemas mais comuns.</h4>
				<div class="col-xs-8 col-sm-8 col-md-10 col-lg-10 col-md-push-1 col-lg-push-1 col-sm-push-1" id="stats2">
					<svg>
						<g id="canvas">
							<g id="art" />
							<g id="labels" /></g>
					</svg>
				</div>
			</div>
			<div class="row">
				<h4 class="section-heading">Top 10 - Piores Linhas.</h4>
				<div class="col-xs-8 col-sm-8 col-md-10 col-lg-10 col-md-push-1 col-lg-push-1 col-sm-push-1" id="stats">
					<div id="worstLines"></div>
				</div> 
	        </div> 

			<div class="row">
				<h4 class="section-heading">Top 10 - Piores Linhas por tipo de reclamação.</h4>
				<div class="btn-group">
				<button class="btn btn-default btn-lg dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false">
					Selecionar Tipo de Reclamação <span class="caret"></span>
				  </button>
				  <ul class="dropdown-menu" role="menu"></ul>
				</div>
				<!--<div class="col-xs-8 col-sm-8 col-md-10 col-lg-10 col-md-push-1 col-lg-push-1 col-sm-push-1" id="stats3">
					<div id='outer' style="width: 1000px; height:800px; margin: 0px auto; margin-top:20px; padding:10px">
						<div id="main" style="width:1000px; height:200px; margin: 0px auto; ">
							<div id="div1"></div>
							<div id="div2"></div>
							<div id="div3"></div>
							<div id="div4"></div>
						</div>
					</div>
				</div>-->
				
			</div>
		    <div class="row">
				<div class="titulo"></div>
				<div id="stats">
					<div id="chart"></div>
				</div>
			</div>
	    </div>
	    </div>
     </div>
   

		<!-- Footer -->
		<footer>
			<div class="container">
				<div class="row">
					<div class="col-lg-12 col-sm-12 col-xs-12 col-md-12">
						<ul class="list-inline">
							<li>
								<a href="#home">Home</a>
							</li>
							<li class="footer-menu-divider">&sdot;</li>
							<li>
								<a href="#about">Sobre</a>
							</li>
							<li class="footer-menu-divider">&sdot;</li>
							<li>
								<a href="#services">Estatísticas</a>
							</li>
							<li class="footer-menu-divider">&sdot;</li>
							<li>
								<a href="#contact">Equipe</a>
							</li>
							<li>
								<a href="#contact">Reclamação</a>
							</li>
							<li>
								<a href="#contact">Fale Conosco</a>
							</li>
						</ul>
						<p class="copyright text-muted small">Copyright &copy; TransReport 2015. Todos os direitos reservados</p>
					</div>
				</div>
			</div>
		</footer>

		<!-- jQuery -->
		<script src="js/jquery.js"></script>

		<!-- Bootstrap Core JavaScript -->
		<script src="js/bootstrap.min.js"></script>

		<script src="js/transreport.js"></script>

		<!-- custom scripts -->
		<script src="/socket.io/socket.io.js"></script>
		<script src="http://d3js.org/d3.v3.min.js"></script>
		

		<script type="text/javascript">

			$(function(){
				//default
				$.get("/stats/types/", function (result) {
					
					$(".dropdown-menu").html(''); 
					$(".dropdown-menu").html(result);

					$.get("/total/", function (result) {
						$('#worstLines').html(''); 
						drawBar(JSON.parse(result), "#worstLines");
					});

					$.get("/totalByOcc/", function (result) {
						 
						drawPie(JSON.parse(result));
					});

					$(".typeOcc").on('click', function () {
						var index = $(this).attr('value');
						var titulo = $(this).text();
						$.get("/tipo/"+index, function (result) {
							$("#chart").html('');
							$(".titulo").html('');
							$(".titulo").html('<h4>'+titulo+'</h4><br>');
							drawBar(JSON.parse(result), "#chart");
						});
					});
				});

				
			});

			function drawBar (dataFromMongo, elem) {
				var margin = {top: 20, right: 20, bottom: 30, left: 40},
				width = 960 - margin.left - margin.right,
				height = 500 - margin.top - margin.bottom;

				var x = d3.scale.ordinal().rangeRoundBands([0, width], .1);

				var y = d3.scale.linear().range([height, 0]);

				var xAxis = d3.svg.axis().scale(x).orient("bottom");

				var yAxis = d3.svg.axis().scale(y).orient("left").ticks(10, "");

				var svg = d3.select(elem).append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom).append("g")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

				data = dataFromMongo;
				//console.log(data);
				x.domain(data.map(function(d) { return d.busNum; }));
				y.domain([0, d3.max(data, function(d) { return d.qty; })]);

				svg.append("g")
				.attr("class", "x axis")
				.attr("transform", "translate(0," + height + ")").call(xAxis);

				svg.append("g").attr("class", "y axis").call(yAxis).append("text")
				.attr("transform", "rotate(-90)")
				.attr("y", 6)
				.attr("dy", ".71em").style("text-anchor", "end").text("Nº de Reclamações");

				svg.selectAll(".bar").data(data).enter().append("rect")
				.attr("class", "bar")
				.attr("x", function(d) { return x(d.busNum); })
				.attr("width", x.rangeBand())
				.attr("y", function(d) { return y(d.qty); })
				.attr("height", function(d) { return height - y(d.qty); });
			}

			function drawPie(dataFromMongo){
				data = dataFromMongo;
				svg = d3.select("svg");
				canvas = d3.select("#canvas");
				art = d3.select("#art");
				labels = d3.select("#labels");

				jhw_pie = d3.layout.pie()
				jhw_pie.value(function (d, i) { 
				    return d.instances;
				});

				cDim = {
				    height: 650,
				    width: 900,
				    innerRadius: 50,
				    outerRadius: 150,
				    labelRadius: 150
				}

				svg.attr({
				    height: cDim.height,
				    width: cDim.width
				});

				canvas.attr("transform", "translate(" + (cDim.width / 2) + "," + (cDim.width / 2) + ")");

				pied_data = jhw_pie(data);

				pied_arc = d3.svg.arc()
				    .innerRadius(50)
				    .outerRadius(150);

				pied_colors = d3.scale.category20();

				enteringArcs = art.selectAll(".wedge").data(pied_data).enter();

				enteringArcs.append("path")
				    .attr("class", "wedge")
				    .attr("d", pied_arc)
				    .style("fill", function (d, i) {
				    return pied_colors(i);
				});

				enteringLabels = labels.selectAll(".label").data(pied_data).enter();
				labelGroups = enteringLabels.append("g").attr("class", "label");
				labelGroups.append("circle").attr({
				    x: 0,
				    y: 0,
				    r: 2,
				    fill: "#000",
				    transform: function (d, i) {
				        centroid = pied_arc.centroid(d);
				        return "translate(" + pied_arc.centroid(d) + ")";
				    },
				        'class': "label-circle"
				});

				textLines = labelGroups.append("line").attr({
				    x1: function (d, i) {
				        return pied_arc.centroid(d)[0];
				    },
				    y1: function (d, i) {
				        return pied_arc.centroid(d)[1];
				    },
				    x2: function (d, i) {
				        centroid = pied_arc.centroid(d);
				        midAngle = Math.atan2(centroid[1], centroid[0]);
				        x = Math.cos(midAngle) * cDim.labelRadius;
				        return x;
				    },
				    y2: function (d, i) {
				        centroid = pied_arc.centroid(d);
				        midAngle = Math.atan2(centroid[1], centroid[0]);
				        y = Math.sin(midAngle) * cDim.labelRadius;
				        return y;
				    },
				        'class': "label-line"
				});

				textLabels = labelGroups.append("text").attr({
				    x: function (d, i) {
				        centroid = pied_arc.centroid(d);
				        midAngle = Math.atan2(centroid[1], centroid[0]);
				        x = Math.cos(midAngle) * cDim.labelRadius;
				        sign = (x > 0) ? 1 : -1
				        labelX = x + (5 * sign)
				        return labelX;
				    },
				    y: function (d, i) {
				        centroid = pied_arc.centroid(d);
				        midAngle = Math.atan2(centroid[1], centroid[0]);
				        y = Math.sin(midAngle) * cDim.labelRadius;
				        return y;
				    },
				        'text-anchor': function (d, i) {
				        centroid = pied_arc.centroid(d);
				        midAngle = Math.atan2(centroid[1], centroid[0]);
				        x = Math.cos(midAngle) * cDim.labelRadius;
				        return (x > 0) ? "start" : "end";
				    },
				        'class': 'label-text'
				}).text(function (d) {
				    return d.data.label
				});

				alpha = 0.5;
				spacing = 12;

				function relax() {
				    again = false;
				    textLabels.each(function (d, i) {
				        a = this;
				        da = d3.select(a);
				        y1 = da.attr("y");
				        textLabels.each(function (d, j) {
				            b = this;
				            
				            if (a == b) return;
				            db = d3.select(b);
				            
				            if (da.attr("text-anchor") != db.attr("text-anchor")) return;
				            
				            y2 = db.attr("y");
				            deltaY = y1 - y2;
				            
				            if (Math.abs(deltaY) > spacing) return;
				       
				            again = true;
				            sign = deltaY > 0 ? 1 : -1;
				            adjust = sign * alpha;
				            da.attr("y",+y1 + adjust);
				            db.attr("y",+y2 - adjust);
				        });
				    });
				    
				    if(again) {
				        labelElements = textLabels[0];
				        textLines.attr("y2",function(d,i) {
				            labelForLine = d3.select(labelElements[i]);
				            return labelForLine.attr("y");
				        });
				        setTimeout(relax,20)
				    }
				}
				relax();
			}
			
			
			/*stats3*/
			var div1=d3.select(document.getElementById('div1'));
			var div2=d3.select(document.getElementById('div2'));
			var div3=d3.select(document.getElementById('div3'));
			var div4=d3.select(document.getElementById('div4'));

			start();

			function onClick1() {
				deselect();
				div1.attr("class","selectedRadial");
			}

			function onClick2() {
				deselect();
				div2.attr("class","selectedRadial");
			}

			function onClick3() {
				deselect();
				div3.attr("class","selectedRadial");
			}

			function labelFunction(val,min,max) {

			}

			function deselect() {
				div1.attr("class","radial");
				div2.attr("class","radial");
				div3.attr("class","radial");
			}

			function start() {

				var rp1 = radialProgress(document.getElementById('div1'))
						.label("RADIAL 1")
						.onClick(onClick1)
						.diameter(150)
						.value(78)
						.render();

				var rp2 = radialProgress(document.getElementById('div2'))
						.label("RADIAL 2")
						.onClick(onClick2)
						.diameter(150)
						.value(132)
						.render();

				var rp3 = radialProgress(document.getElementById('div3'))
						.label("RADIAL 3")
						.onClick(onClick3)
						.diameter(150)
						.minValue(100)
						.maxValue(200)
						.value(150)
						.render();

			}
			
		</script>
</body>
</html>
